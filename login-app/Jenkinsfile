pipeline {
  agent any 
  tools { maven 'maven3' }  
  options { timestamps() }

  environment {
    APP_NAME   = 'login-app'
    TOMCAT_URL-1 = 'http://192.168.0.198:8081'
    TOMCAT_URL-2 = 'http://192.168.0.199:8081'
    CRED_ID    = 'tomcat-deploy'
  }

 stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build WAR') {
      steps {
        dir('login-app') {
          sh 'mvn -B clean package -DskipTests'
          stash includes: 'target/*.war', name: 'war'
        }
      }
      post {
        success {
          archiveArtifacts artifacts: 'login-app/target/*.war', fingerprint: true
        }
      }
    }

    stage('Deploy to Tomcat (Manager API)') {
      steps {
        unstash 'war'
        withCredentials([usernamePassword(credentialsId: "${CRED_ID}", usernameVariable: 'USER', passwordVariable: 'PASS')]) {
          sh """
            curl -sf -u "$USER:$PASS" "${TOMCAT_URL-1}/manager/text/undeploy?path=/${APP_NAME}" || true
            curl -sf -u "$USER:$PASS" \
              -T login-app/target/${APP_NAME}.war \
              "${TOMCAT_URL-1}/manager/text/deploy?path=/${APP_NAME}&update=true"

            curl -sf -u "$USER:$PASS" "${TOMCAT_URL-2}/manager/text/undeploy?path=/${APP_NAME}" || true
            curl -sf -u "$USER:$PASS" \
              -T login-app/target/${APP_NAME}.war \
              "${TOMCAT_URL-2}/manager/text/deploy?path=/${APP_NAME}&update=true"
          """
        }
      }
    }
  }

  post {
    success { echo "배포 완료: ${TOMCAT_URL}/${APP_NAME}/" }
  }
}
